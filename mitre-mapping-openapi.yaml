openapi: 3.0.1
info:
  title: MITRE ATT&CK Mapping Agent API
  version: "1.1.0"
  description: >
    APIs for fetching Microsoft Sentinel analytic rules and
    classifying them with MITRE ATT&CK using AI.

servers:
  - url: https://mitreattackmappingagent.azurewebsites.net/api

paths:
  /sentinel/rules/all:
    get:
      operationId: getAllSentinelRules
      summary: Fetch Microsoft Sentinel analytic rules using deterministic pagination
      description: >
        Retrieves Microsoft Sentinel analytic rules from the specified workspace
        using deterministic pagination. Clients must start with skip=0 and use
        the nextSkip value returned in each response to fetch subsequent batches.
        Reusing the same skip value across requests will result in duplicate data.

      parameters:
        - name: skip
          in: query
          required: false
          description: >
            Number of analytic rules to skip before starting to return results.
            Must be set to 0 for the initial request. For subsequent requests,
            this value must be taken from the nextSkip field of the previous response.
          schema:
            type: integer
            minimum: 0
            default: 0

        - name: top
          in: query
          required: false
          description: >
            Number of analytic rules to return in the current batch.
            Recommended value is 25 to avoid response size limits.
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 25

      responses:
        "200":
          description: Paginated batch of Sentinel analytic rules
          content:
            application/json:
              schema:
                type: object
                required:
                  - totalRules
                  - returned
                  - skip
                  - top
                  - nextSkip
                  - rules
                properties:
                  totalRules:
                    type: integer
                    description: Total number of analytic rules in the workspace.

                  returned:
                    type: integer
                    description: Number of rules returned in this batch.

                  skip:
                    type: integer
                    description: Number of rules skipped in this request.

                  top:
                    type: integer
                    description: Batch size requested.

                  nextSkip:
                    type: integer
                    nullable: true
                    description: >
                      Value to be used as the skip parameter for the next request.
                      If null, no additional rules are available and pagination must stop.

                  rules:
                    type: array
                    description: List of Sentinel analytic rules in the current batch.
                    items:
                      type: object
                      required:
                        - ruleId
                        - displayName
                      properties:
                        ruleId:
                          type: string
                          description: Unique identifier of the analytic rule.

                        displayName:
                          type: string
                          description: Display name of the analytic rule.

                        severity:
                          type: string
                          enum: [Low, Medium, High, Informational]

                        enabled:
                          type: boolean

                        tactics:
                          type: array
                          items:
                            type: string

                        techniques:
                          type: array
                          items:
                            type: string

                        lastModifiedUtc:
                          type: string
                          format: date-time

                        kind:
                          type: string
                          description: Type of analytic rule (Scheduled, Fusion, etc.)

        "400":
          description: Invalid pagination parameters supplied.

        "500":
          description: Server error while fetching Sentinel analytic rules.

  /sentinel/rules/without-mitre:
    get:
      operationId: GetUnmappedSentinelRule
      summary: Fetch the next Sentinel rule without MITRE mapping
      description: >
        Returns ONE deterministic analytic rule that does not have MITRE techniques.
        The rule selected is the oldest un-mapped rule by lastModifiedUtc.
      responses:
        "200":
          description: Sentinel rule without MITRE
          content:
            application/json:
              schema:
                type: object
                properties:
                  ruleId:
                    type: string
                  displayName:
                    type: string
                  description:
                    type: string
                  query:
                    type: string
                  tactics:
                    type: array
                    items:
                      type: string
                  techniques:
                    type: array
                    items:
                      type: string
                  lastModifiedUtc:
                    type: string
                    format: date-time

  /mitre/classify:
    post:
      operationId: ClassifyMitreRule
      summary: Classify MITRE ATT&CK mapping using Gemini
      description: >
        Uses Gemini AI to determine the most accurate MITRE ATT&CK tactics
        and techniques for a Sentinel analytic rule.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: Minimal Sentinel rule payload
              properties:
                displayName:
                  type: string
                description:
                  type: string
                query:
                  type: string
                tactics:
                  type: array
                  items:
                    type: string
                techniques:
                  type: array
                  items:
                    type: string
      responses:
        "200":
          description: MITRE classification result
          content:
            application/json:
              schema:
                type: object
                properties:
                  tactics:
                    type: array
                    items:
                      type: string
                  techniques:
                    type: array
                    items:
                      type: string
                  confidence:
                    type: number
